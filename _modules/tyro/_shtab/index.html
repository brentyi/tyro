<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex/" /><link rel="search" title="Search" href="../../../search/" />

    <meta name="generator" content="sphinx-5.0.2, furo 2022.06.21"/>
        <title>tyro._shtab - tyro</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?digest=40978830699223671f4072448e654b5958f38b89" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/compact_table_header.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/ansi.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  --color-code-background: #f4f4f4;
  --color-code-foreground: #000;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../"><div class="brand">tyro</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../../_static/logo-light.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../../_static/logo-dark.svg" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">tyro</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search/" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../your_first_cli/">Your first CLI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../helptext_generation/">Helptext generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tab_completion/">Tab completion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../building_configuration_systems/">Building configuration systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../goals_and_alternatives/">Goals and alternatives</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/01_functions/">1. Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/02_dataclasses/">2. Dataclasses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/03_enums_and_containers/">3. Enums And Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/04_flags/">4. Flags</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/05_hierarchical_configs/">5. Hierarchical Configs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/06_literals_and_unions/">6. Literals And Unions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/07_positional_args/">7. Positional Args</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/08_subcommands/">8. Subcommands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/09_multiple_subcommands/">9. Multiple Subcommands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/10_base_configs/">10. Base Configs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/11_dictionaries/">11. Dictionaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/12_tuples/">12. Tuples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/13_standard_classes/">13. Standard Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/14_generics/">14. Generics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/15_nesting_in_containers/">15. Nesting In Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/16_advanced_configuration/">16. Advanced Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/17_flax_modules/">17. Flax Modules</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api/tyro/"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tyro</span></code></a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/tyro/conf/"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tyro.conf</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/tyro/extras/"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tyro.extras</span></code></a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for tyro._shtab</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SUPPRESS</span><span class="p">,</span>
    <span class="n">Action</span><span class="p">,</span>
    <span class="n">ArgumentParser</span><span class="p">,</span>
    <span class="n">_AppendAction</span><span class="p">,</span>
    <span class="n">_AppendConstAction</span><span class="p">,</span>
    <span class="n">_CountAction</span><span class="p">,</span>
    <span class="n">_HelpAction</span><span class="p">,</span>
    <span class="n">_StoreConstAction</span><span class="p">,</span>
    <span class="n">_VersionAction</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">total_ordering</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">starmap</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span> <span class="k">as</span> <span class="n">Opt</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="c1"># version detector. Precedence: installed dist, git, &#39;UNKNOWN&#39;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">._dist_ver</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">setuptools_scm</span> <span class="kn">import</span> <span class="n">get_version</span>

        <span class="n">__version__</span> <span class="o">=</span> <span class="n">get_version</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="n">relative_to</span><span class="o">=</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">LookupError</span><span class="p">):</span>
        <span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;UNKNOWN&quot;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;complete&quot;</span><span class="p">,</span>
    <span class="s2">&quot;add_argument_to&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SUPPORTED_SHELLS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FILE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DIRECTORY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DIR&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">SUPPORTED_SHELLS</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">_SUPPORTED_COMPLETERS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">CHOICE_FUNCTIONS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bash&quot;</span><span class="p">:</span> <span class="s2">&quot;_shtab_compgen_files&quot;</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">:</span> <span class="s2">&quot;_files&quot;</span><span class="p">,</span> <span class="s2">&quot;tcsh&quot;</span><span class="p">:</span> <span class="s2">&quot;f&quot;</span><span class="p">},</span>
    <span class="s2">&quot;directory&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bash&quot;</span><span class="p">:</span> <span class="s2">&quot;_shtab_compgen_dirs&quot;</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">:</span> <span class="s2">&quot;_files -/&quot;</span><span class="p">,</span> <span class="s2">&quot;tcsh&quot;</span><span class="p">:</span> <span class="s2">&quot;d&quot;</span><span class="p">},</span>
<span class="p">}</span>
<span class="n">FILE</span> <span class="o">=</span> <span class="n">CHOICE_FUNCTIONS</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>
<span class="n">DIRECTORY</span> <span class="o">=</span> <span class="n">DIR</span> <span class="o">=</span> <span class="n">CHOICE_FUNCTIONS</span><span class="p">[</span><span class="s2">&quot;directory&quot;</span><span class="p">]</span>
<span class="n">FLAG_OPTION</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">_StoreConstAction</span><span class="p">,</span>
    <span class="n">_HelpAction</span><span class="p">,</span>
    <span class="n">_VersionAction</span><span class="p">,</span>
    <span class="n">_AppendConstAction</span><span class="p">,</span>
    <span class="n">_CountAction</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">OPTION_END</span> <span class="o">=</span> <span class="n">_HelpAction</span><span class="p">,</span> <span class="n">_VersionAction</span>
<span class="n">OPTION_MULTI</span> <span class="o">=</span> <span class="n">_AppendAction</span><span class="p">,</span> <span class="n">_AppendConstAction</span><span class="p">,</span> <span class="n">_CountAction</span>
<span class="n">RE_ZSH_SPECIAL_CHARS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([^\w\s.,()-])&quot;</span><span class="p">)</span>  <span class="c1"># excessive but safe</span>


<span class="k">def</span> <span class="nf">mark_completer</span><span class="p">(</span><span class="n">shell</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">shell</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPPORTED_SHELLS</span><span class="p">:</span>
            <span class="n">SUPPORTED_SHELLS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shell</span><span class="p">)</span>
        <span class="n">_SUPPORTED_COMPLETERS</span><span class="p">[</span><span class="n">shell</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">def</span> <span class="nf">get_completer</span><span class="p">(</span><span class="n">shell</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_SUPPORTED_COMPLETERS</span><span class="p">[</span><span class="n">shell</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;shell (</span><span class="si">%s</span><span class="s2">) must be in {</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SUPPORTED_SHELLS</span><span class="p">))</span>
        <span class="p">)</span>


<span class="nd">@total_ordering</span>
<span class="k">class</span> <span class="nc">Choice</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Placeholder to mark a special completion `&lt;type&gt;`.</span>

<span class="sd">    &gt;&gt;&gt; ArgumentParser.add_argument(..., choices=[Choice(&quot;&lt;type&gt;&quot;)])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">choice_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See below for parameters.</span>

<span class="sd">        choice_type  : internal `type` name</span>
<span class="sd">        required  : controls result of comparison to empty strings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="n">required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">choice_type</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="k">else</span> <span class="s2">&quot;?&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">required</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">other</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>


<span class="k">class</span> <span class="nc">Optional</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Example: `ArgumentParser.add_argument(..., choices=Optional.FILE)`.&quot;&quot;&quot;</span>

    <span class="n">FILE</span> <span class="o">=</span> <span class="p">[</span><span class="n">Choice</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)]</span>
    <span class="n">DIR</span> <span class="o">=</span> <span class="n">DIRECTORY</span> <span class="o">=</span> <span class="p">[</span><span class="n">Choice</span><span class="p">(</span><span class="s2">&quot;directory&quot;</span><span class="p">)]</span>


<span class="k">class</span> <span class="nc">Required</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Example: `ArgumentParser.add_argument(..., choices=Required.FILE)`.&quot;&quot;&quot;</span>

    <span class="n">FILE</span> <span class="o">=</span> <span class="p">[</span><span class="n">Choice</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)]</span>
    <span class="n">DIR</span> <span class="o">=</span> <span class="n">DIRECTORY</span> <span class="o">=</span> <span class="p">[</span><span class="n">Choice</span><span class="p">(</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">complete2pattern</span><span class="p">(</span><span class="n">opt_complete</span><span class="p">,</span> <span class="n">shell</span><span class="p">,</span> <span class="n">choice_type2fn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">opt_complete</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt_complete</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">choice_type2fn</span><span class="p">[</span><span class="n">opt_complete</span><span class="p">]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">wordify</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Replace non-word chars [-. ] with underscores [_]&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[-.\s:]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_public_subcommands</span><span class="p">(</span><span class="n">sub</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get all the publicly-visible subcommands for a given subparser.&quot;&quot;&quot;</span>
    <span class="n">public_parsers</span> <span class="o">=</span> <span class="p">{</span><span class="nb">id</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">dest</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">_get_subactions</span><span class="p">()}</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">choices</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">public_parsers</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">get_bash_commands</span><span class="p">(</span><span class="n">root_parser</span><span class="p">,</span> <span class="n">root_prefix</span><span class="p">,</span> <span class="n">choice_functions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recursive subcommand parser traversal, returning lists of information on</span>
<span class="sd">    commands (formatted for output to the completions script).</span>
<span class="sd">    printing bash helper syntax.</span>

<span class="sd">    Returns:</span>
<span class="sd">      subparsers  : list of subparsers for each parser</span>
<span class="sd">      option_strings  : list of options strings for each parser</span>
<span class="sd">      compgens  : list of shtab `.complete` functions corresponding to actions</span>
<span class="sd">      choices  : list of choices corresponding to actions</span>
<span class="sd">      nargs  : list of number of args allowed for each action (if not 0 or 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">choice_type2fn</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;bash&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">CHOICE_FUNCTIONS</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">choice_functions</span><span class="p">:</span>
        <span class="n">choice_type2fn</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">choice_functions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_option_strings</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flattened list of all `parser`&#39;s option strings.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">option_strings</span>
                <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_get_optional_actions</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">help</span> <span class="o">!=</span> <span class="n">SUPPRESS</span>
            <span class="p">),</span>
            <span class="p">[],</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">recurse</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;recurse through subparsers, appending to the return lists&quot;&quot;&quot;</span>
        <span class="n">subparsers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">option_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">compgens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># temp lists for recursion results</span>
        <span class="n">sub_subparsers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sub_option_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sub_compgens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sub_choices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sub_nargs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># positional arguments</span>
        <span class="n">discovered_subparsers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">positional</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">_get_positional_actions</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">positional</span><span class="o">.</span><span class="n">help</span> <span class="o">==</span> <span class="n">SUPPRESS</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">positional</span><span class="p">,</span> <span class="s2">&quot;complete&quot;</span><span class="p">):</span>
                <span class="c1"># shtab `.complete = ...` functions</span>
                <span class="n">compgens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_pos_</span><span class="si">{}</span><span class="s2">_COMPGEN=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">prefix</span><span class="p">,</span>
                        <span class="n">i</span><span class="p">,</span>
                        <span class="n">complete2pattern</span><span class="p">(</span><span class="n">positional</span><span class="o">.</span><span class="n">complete</span><span class="p">,</span> <span class="s2">&quot;bash&quot;</span><span class="p">,</span> <span class="n">choice_type2fn</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">positional</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
                <span class="c1"># choices (including subparsers &amp; shtab `.complete` functions)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;choices:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">positional</span><span class="o">.</span><span class="n">choices</span><span class="p">)))</span>

                <span class="n">this_positional_choices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">choice</span> <span class="ow">in</span> <span class="n">positional</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span> <span class="n">Choice</span><span class="p">):</span>
                        <span class="c1"># append special completion type to `compgens`</span>
                        <span class="c1"># NOTE: overrides `.complete` attribute</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Choice.</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">choice</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">positional</span><span class="o">.</span><span class="n">dest</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">compgens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_pos_</span><span class="si">{}</span><span class="s2">_COMPGEN=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">prefix</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">choice_type2fn</span><span class="p">[</span><span class="n">choice</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">positional</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="c1"># subparser, so append to list of subparsers &amp; recurse</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;subcommand:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">choice</span><span class="p">)</span>
                        <span class="n">public_cmds</span> <span class="o">=</span> <span class="n">get_public_subcommands</span><span class="p">(</span><span class="n">positional</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">choice</span> <span class="ow">in</span> <span class="n">public_cmds</span><span class="p">:</span>
                            <span class="n">discovered_subparsers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>
                            <span class="n">this_positional_choices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>
                            <span class="p">(</span>
                                <span class="n">new_subparsers</span><span class="p">,</span>
                                <span class="n">new_option_strings</span><span class="p">,</span>
                                <span class="n">new_compgens</span><span class="p">,</span>
                                <span class="n">new_choices</span><span class="p">,</span>
                                <span class="n">new_nargs</span><span class="p">,</span>
                            <span class="p">)</span> <span class="o">=</span> <span class="n">recurse</span><span class="p">(</span>
                                <span class="n">positional</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="n">choice</span><span class="p">],</span>
                                <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">wordify</span><span class="p">(</span><span class="n">choice</span><span class="p">),</span>
                            <span class="p">)</span>
                            <span class="n">sub_subparsers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_subparsers</span><span class="p">)</span>
                            <span class="n">sub_option_strings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_option_strings</span><span class="p">)</span>
                            <span class="n">sub_compgens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_compgens</span><span class="p">)</span>
                            <span class="n">sub_choices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_choices</span><span class="p">)</span>
                            <span class="n">sub_nargs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_nargs</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;skip:subcommand:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">choice</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># simple choice</span>
                        <span class="n">this_positional_choices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">this_positional_choices</span><span class="p">:</span>
                    <span class="n">choices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_pos_</span><span class="si">{}</span><span class="s2">_choices=(&#39;</span><span class="si">{}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">prefix</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&#39; &#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">this_positional_choices</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="c1"># skip default `nargs` values</span>
            <span class="k">if</span> <span class="n">positional</span><span class="o">.</span><span class="n">nargs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">):</span>
                <span class="n">nargs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_pos_</span><span class="si">{}</span><span class="s2">_nargs=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">positional</span><span class="o">.</span><span class="n">nargs</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">discovered_subparsers</span><span class="p">:</span>
            <span class="n">subparsers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_subparsers=(&#39;</span><span class="si">{}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;&#39; &#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">discovered_subparsers</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;subcommands:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">discovered_subparsers</span><span class="p">))</span>

        <span class="c1"># optional arguments</span>
        <span class="n">option_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_option_strings=(&#39;</span><span class="si">{}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;&#39; &#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_option_strings</span><span class="p">(</span><span class="n">parser</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">optional</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_get_optional_actions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">optional</span> <span class="o">==</span> <span class="n">SUPPRESS</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">option_string</span> <span class="ow">in</span> <span class="n">optional</span><span class="o">.</span><span class="n">option_strings</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">optional</span><span class="p">,</span> <span class="s2">&quot;complete&quot;</span><span class="p">):</span>
                    <span class="c1"># shtab `.complete = ...` functions</span>
                    <span class="n">compgens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_COMPGEN=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">prefix</span><span class="p">,</span>
                            <span class="n">wordify</span><span class="p">(</span><span class="n">option_string</span><span class="p">),</span>
                            <span class="n">complete2pattern</span><span class="p">(</span><span class="n">optional</span><span class="o">.</span><span class="n">complete</span><span class="p">,</span> <span class="s2">&quot;bash&quot;</span><span class="p">,</span> <span class="n">choice_type2fn</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">optional</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
                    <span class="c1"># choices (including shtab `.complete` functions)</span>
                    <span class="n">this_optional_choices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">choice</span> <span class="ow">in</span> <span class="n">optional</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
                        <span class="c1"># append special completion type to `compgens`</span>
                        <span class="c1"># NOTE: overrides `.complete` attribute</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span> <span class="n">Choice</span><span class="p">):</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s2">&quot;Choice.</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">choice</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">optional</span><span class="o">.</span><span class="n">dest</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="n">compgens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_COMPGEN=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">prefix</span><span class="p">,</span>
                                    <span class="n">wordify</span><span class="p">(</span><span class="n">option_string</span><span class="p">),</span>
                                    <span class="n">choice_type2fn</span><span class="p">[</span><span class="n">choice</span><span class="o">.</span><span class="n">type</span><span class="p">],</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># simple choice</span>
                            <span class="n">this_optional_choices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">this_optional_choices</span><span class="p">:</span>
                        <span class="n">choices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_choices=(&#39;</span><span class="si">{}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">prefix</span><span class="p">,</span>
                                <span class="n">wordify</span><span class="p">(</span><span class="n">option_string</span><span class="p">),</span>
                                <span class="s2">&quot;&#39; &#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">this_optional_choices</span><span class="p">),</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                <span class="c1"># Check for nargs.</span>
                <span class="k">if</span> <span class="n">optional</span><span class="o">.</span><span class="n">nargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">optional</span><span class="o">.</span><span class="n">nargs</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">nargs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_nargs=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">prefix</span><span class="p">,</span> <span class="n">wordify</span><span class="p">(</span><span class="n">option_string</span><span class="p">),</span> <span class="n">optional</span><span class="o">.</span><span class="n">nargs</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1"># append recursion results</span>
        <span class="n">subparsers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sub_subparsers</span><span class="p">)</span>
        <span class="n">option_strings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sub_option_strings</span><span class="p">)</span>
        <span class="n">compgens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sub_compgens</span><span class="p">)</span>
        <span class="n">choices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sub_choices</span><span class="p">)</span>
        <span class="n">nargs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sub_nargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">subparsers</span><span class="p">,</span> <span class="n">option_strings</span><span class="p">,</span> <span class="n">compgens</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">nargs</span>

    <span class="k">return</span> <span class="n">recurse</span><span class="p">(</span><span class="n">root_parser</span><span class="p">,</span> <span class="n">root_prefix</span><span class="p">)</span>


<span class="nd">@mark_completer</span><span class="p">(</span><span class="s2">&quot;bash&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">complete_bash</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">root_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preamble</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">choice_functions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns bash syntax autocompletion script.</span>

<span class="sd">    See `complete` for arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root_prefix</span> <span class="o">=</span> <span class="n">wordify</span><span class="p">(</span><span class="s2">&quot;_shtab_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">root_prefix</span> <span class="ow">or</span> <span class="n">parser</span><span class="o">.</span><span class="n">prog</span><span class="p">))</span>
    <span class="n">subparsers</span><span class="p">,</span> <span class="n">option_strings</span><span class="p">,</span> <span class="n">compgens</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">nargs</span> <span class="o">=</span> <span class="n">get_bash_commands</span><span class="p">(</span>
        <span class="n">parser</span><span class="p">,</span> <span class="n">root_prefix</span><span class="p">,</span> <span class="n">choice_functions</span><span class="o">=</span><span class="n">choice_functions</span>
    <span class="p">)</span>

    <span class="c1"># References:</span>
    <span class="c1"># - https://www.gnu.org/software/bash/manual/html_node/</span>
    <span class="c1">#   Programmable-Completion.html</span>
    <span class="c1"># - https://opensource.com/article/18/3/creating-bash-completion-script</span>
    <span class="c1"># - https://stackoverflow.com/questions/12933362</span>
    <span class="k">return</span> <span class="n">Template</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd"># AUTOMATCALLY GENERATED by `shtab`</span>

<span class="sd">${subparsers}</span>

<span class="sd">${option_strings}</span>

<span class="sd">${compgens}</span>

<span class="sd">${choices}</span>

<span class="sd">${nargs}</span>

<span class="sd">${preamble}</span>
<span class="sd"># $1=COMP_WORDS[1]</span>
<span class="sd">_shtab_compgen_files() {</span>
<span class="sd">  compgen -f -- $1  # files</span>
<span class="sd">}</span>

<span class="sd"># $1=COMP_WORDS[1]</span>
<span class="sd">_shtab_compgen_dirs() {</span>
<span class="sd">  compgen -d -- $1  # recurse into subdirs</span>
<span class="sd">}</span>

<span class="sd"># $1=COMP_WORDS[1]</span>
<span class="sd">_shtab_replace_nonword() {</span>
<span class="sd">  echo &quot;${1//[^[:word:]]/_}&quot;</span>
<span class="sd">}</span>

<span class="sd"># set default values (called for the initial parser &amp; any subparsers)</span>
<span class="sd">_set_parser_defaults() {</span>
<span class="sd">  local subparsers_var=&quot;${prefix}_subparsers[@]&quot;</span>
<span class="sd">  sub_parsers=${!subparsers_var}</span>

<span class="sd">  local current_option_strings_var=&quot;${prefix}_option_strings[@]&quot;</span>
<span class="sd">  current_option_strings=${!current_option_strings_var}</span>

<span class="sd">  completed_positional_actions=0</span>

<span class="sd">  _set_new_action &quot;pos_${completed_positional_actions}&quot; true</span>
<span class="sd">}</span>

<span class="sd"># $1=action identifier</span>
<span class="sd"># $2=positional action (bool)</span>
<span class="sd"># set all identifiers for an action&#39;s parameters</span>
<span class="sd">_set_new_action() {</span>
<span class="sd">  current_action=&quot;${prefix}_$(_shtab_replace_nonword $1)&quot;</span>

<span class="sd">  local current_action_compgen_var=${current_action}_COMPGEN</span>
<span class="sd">  current_action_compgen=&quot;${!current_action_compgen_var}&quot;</span>

<span class="sd">  local current_action_choices_var=&quot;${current_action}_choices[@]&quot;</span>
<span class="sd">  current_action_choices=&quot;${!current_action_choices_var}&quot;</span>

<span class="sd">  local current_action_nargs_var=&quot;${current_action}_nargs&quot;</span>
<span class="sd">  if [ -n &quot;${!current_action_nargs_var}&quot; ]; then</span>
<span class="sd">    current_action_nargs=&quot;${!current_action_nargs_var}&quot;</span>
<span class="sd">  else</span>
<span class="sd">    current_action_nargs=1</span>
<span class="sd">  fi</span>

<span class="sd">  current_action_args_start_index=$(( $word_index + 1 ))</span>

<span class="sd">  current_action_is_positional=$2</span>
<span class="sd">}</span>

<span class="sd"># Notes:</span>
<span class="sd"># `COMPREPLY`: what will be rendered after completion is triggered</span>
<span class="sd"># `completing_word`: currently typed word to generate completions for</span>
<span class="sd"># `${!var}`: evaluates the content of `var` and expand its content as a variable</span>
<span class="sd">#     hello=&quot;world&quot;</span>
<span class="sd">#     x=&quot;hello&quot;</span>
<span class="sd">#     ${!x} -&gt; ${hello} -&gt; &quot;world&quot;</span>
<span class="sd">${root_prefix}() {</span>
<span class="sd">  local completing_word=&quot;${COMP_WORDS[COMP_CWORD]}&quot;</span>
<span class="sd">  COMPREPLY=()</span>

<span class="sd">  prefix=${root_prefix}</span>
<span class="sd">  word_index=0</span>
<span class="sd">  _set_parser_defaults</span>
<span class="sd">  word_index=1</span>

<span class="sd">  # determine what arguments are appropriate for the current state</span>
<span class="sd">  # of the arg parser</span>
<span class="sd">  while [ $word_index -ne $COMP_CWORD ]; do</span>
<span class="sd">    local this_word=&quot;${COMP_WORDS[$word_index]}&quot;</span>

<span class="sd">    if [[ -n $sub_parsers &amp;&amp; &quot; ${sub_parsers[@]} &quot; =~ &quot; ${this_word} &quot; ]]; then</span>
<span class="sd">      # valid subcommand: add it to the prefix &amp; reset the current action</span>
<span class="sd">      prefix=&quot;${prefix}_$(_shtab_replace_nonword $this_word)&quot;</span>
<span class="sd">      _set_parser_defaults</span>
<span class="sd">    fi</span>

<span class="sd">    if [[ &quot; ${current_option_strings[@]} &quot; =~ &quot; ${this_word} &quot; ]]; then</span>
<span class="sd">      # a new action should be acquired (due to recognised option string or</span>
<span class="sd">      # no more input expected from current action);</span>
<span class="sd">      # the next positional action can fill in here</span>
<span class="sd">      _set_new_action $this_word false</span>
<span class="sd">    fi</span>

<span class="sd">    if [[ &quot;$current_action_nargs&quot; != &quot;*&quot; ]] &amp;&amp; \\</span>
<span class="sd">       [[ &quot;$current_action_nargs&quot; != &quot;+&quot; ]] &amp;&amp; \\</span>
<span class="sd">       [[ &quot;$current_action_nargs&quot; != *&quot;...&quot; ]] &amp;&amp; \\</span>
<span class="sd">       (( $word_index + 1 - $current_action_args_start_index &gt;= \\</span>
<span class="sd">          $current_action_nargs )); then</span>
<span class="sd">      $current_action_is_positional &amp;&amp; let &quot;completed_positional_actions += 1&quot;</span>
<span class="sd">      _set_new_action &quot;pos_${completed_positional_actions}&quot; true</span>
<span class="sd">    fi</span>

<span class="sd">    let &quot;word_index+=1&quot;</span>
<span class="sd">  done</span>

<span class="sd">  # Generate the completions</span>

<span class="sd">  if [[ &quot;${completing_word}&quot; == -* ]]; then</span>
<span class="sd">    # optional argument started: use option strings</span>
<span class="sd">    COMPREPLY=( $(compgen -W &quot;${current_option_strings[*]}&quot; -- &quot;${completing_word}&quot;) )</span>
<span class="sd">  else</span>
<span class="sd">    # use choices &amp; compgen</span>
<span class="sd">    COMPREPLY=( $(compgen -W &quot;${current_action_choices[*]}&quot; -- &quot;${completing_word}&quot;) \\</span>
<span class="sd">                $([ -n &quot;${current_action_compgen}&quot; ] \\</span>
<span class="sd">                  &amp;&amp; &quot;${current_action_compgen}&quot; &quot;${completing_word}&quot;) )</span>
<span class="sd">  fi</span>

<span class="sd">  return 0</span>
<span class="sd">}</span>

<span class="sd">complete -o filenames -F ${root_prefix} ${prog}&quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subparsers</span><span class="p">),</span>
        <span class="n">option_strings</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">option_strings</span><span class="p">),</span>
        <span class="n">compgens</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">compgens</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">choices</span><span class="p">),</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nargs</span><span class="p">),</span>
        <span class="n">preamble</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># Custom Preamble</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">preamble</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># End Custom Preamble</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">preamble</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">),</span>
        <span class="n">root_prefix</span><span class="o">=</span><span class="n">root_prefix</span><span class="p">,</span>
        <span class="n">prog</span><span class="o">=</span><span class="n">parser</span><span class="o">.</span><span class="n">prog</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">escape_zsh</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">RE_ZSH_SPECIAL_CHARS</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">\1&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>


<span class="nd">@mark_completer</span><span class="p">(</span><span class="s2">&quot;zsh&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">complete_zsh</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">root_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preamble</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">choice_functions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns zsh syntax autocompletion script.</span>

<span class="sd">    See `complete` for arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">prog</span>
    <span class="n">root_prefix</span> <span class="o">=</span> <span class="n">wordify</span><span class="p">(</span><span class="s2">&quot;_shtab_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">root_prefix</span> <span class="ow">or</span> <span class="n">prog</span><span class="p">))</span>

    <span class="n">choice_type2fn</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;zsh&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">CHOICE_FUNCTIONS</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">choice_functions</span><span class="p">:</span>
        <span class="n">choice_type2fn</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">choice_functions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">format_optional</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">{nargs}{options}</span><span class="s1">&quot;[</span><span class="si">{help}</span><span class="s1">]&quot;&#39;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">FLAG_OPTION</span><span class="p">)</span>
                <span class="k">else</span> <span class="s1">&#39;</span><span class="si">{nargs}{options}</span><span class="s1">&quot;[</span><span class="si">{help}</span><span class="s1">]:</span><span class="si">{dest}</span><span class="s1">:</span><span class="si">{pattern}</span><span class="s1">&quot;&#39;</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">nargs</span><span class="o">=</span><span class="p">(</span>
                    <span class="s1">&#39;&quot;(- :)&quot;&#39;</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">OPTION_END</span><span class="p">)</span>
                    <span class="k">else</span> <span class="s1">&#39;&quot;*&quot;&#39;</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">OPTION_MULTI</span><span class="p">)</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="p">),</span>
                <span class="n">options</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;{{</span><span class="si">{}</span><span class="s2">}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">option_strings</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">option_strings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">option_strings</span><span class="p">))</span>
                <span class="p">),</span>
                <span class="n">help</span><span class="o">=</span><span class="n">escape_zsh</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">help</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="n">dest</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span>
                <span class="n">pattern</span><span class="o">=</span><span class="n">complete2pattern</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">complete</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">,</span> <span class="n">choice_type2fn</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;complete&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">(</span>
                    <span class="n">choice_type2fn</span><span class="p">[</span><span class="n">opt</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Choice</span><span class="p">)</span>
                    <span class="k">else</span> <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">choices</span><span class="p">)))</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">choices</span>
                <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">format_positional</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&quot;</span><span class="si">{nargs}</span><span class="s1">:</span><span class="si">{help}</span><span class="s1">:</span><span class="si">{pattern}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">nargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="s2">&quot;(*)&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="s2">&quot;(*):&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">nargs</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">help</span><span class="o">=</span><span class="n">escape_zsh</span><span class="p">((</span><span class="n">opt</span><span class="o">.</span><span class="n">help</span> <span class="ow">or</span> <span class="n">opt</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">pattern</span><span class="o">=</span><span class="n">complete2pattern</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">complete</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">,</span> <span class="n">choice_type2fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;complete&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">(</span>
                <span class="n">choice_type2fn</span><span class="p">[</span><span class="n">opt</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Choice</span><span class="p">)</span>
                <span class="k">else</span> <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">choices</span><span class="p">)))</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">choices</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># {cmd: {&quot;help&quot;: help, &quot;arguments&quot;: [arguments]}}</span>
    <span class="n">all_commands</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">root_prefix</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="n">prog</span><span class="p">,</span>
            <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">format_optional</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_get_optional_actions</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">help</span> <span class="o">!=</span> <span class="n">SUPPRESS</span>
            <span class="p">],</span>
            <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">description</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;paths&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">recurse</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">subcmds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_get_positional_actions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">help</span> <span class="o">==</span> <span class="n">SUPPRESS</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sub</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sub</span><span class="o">.</span><span class="n">choices</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># positional argument</span>
                <span class="n">all_commands</span><span class="p">[</span><span class="n">prefix</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_positional</span><span class="p">(</span><span class="n">sub</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># subparser</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;choices:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">choices</span><span class="p">)))</span>
                <span class="n">public_cmds</span> <span class="o">=</span> <span class="n">get_public_subcommands</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">subparser</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">choices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">cmd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">public_cmds</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;skip:subcommand:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;subcommand:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

                    <span class="c1"># optionals</span>
                    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">format_optional</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">subparser</span><span class="o">.</span><span class="n">_get_optional_actions</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">help</span> <span class="o">!=</span> <span class="n">SUPPRESS</span>
                    <span class="p">]</span>

                    <span class="c1"># positionals</span>
                    <span class="n">arguments</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="n">format_positional</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">subparser</span><span class="o">.</span><span class="n">_get_positional_actions</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">help</span> <span class="o">!=</span> <span class="n">SUPPRESS</span>
                    <span class="p">)</span>

                    <span class="n">new_pref</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">wordify</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                    <span class="n">options</span> <span class="o">=</span> <span class="n">all_commands</span><span class="p">[</span><span class="n">new_pref</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                        <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">subparser</span><span class="o">.</span><span class="n">description</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">arguments</span><span class="p">,</span>
                        <span class="s2">&quot;paths&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">*</span><span class="n">paths</span><span class="p">,</span> <span class="n">cmd</span><span class="p">],</span>
                    <span class="p">}</span>
                    <span class="n">new_subcmds</span> <span class="o">=</span> <span class="n">recurse</span><span class="p">(</span><span class="n">subparser</span><span class="p">,</span> <span class="n">new_pref</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">paths</span><span class="p">,</span> <span class="n">cmd</span><span class="p">])</span>
                    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">all_commands</span><span class="p">[</span><span class="n">pref</span><span class="p">][</span><span class="s2">&quot;cmd&quot;</span><span class="p">]:</span> <span class="n">all_commands</span><span class="p">[</span><span class="n">pref</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">pref</span> <span class="ow">in</span> <span class="n">new_subcmds</span>
                        <span class="k">if</span> <span class="n">pref</span> <span class="ow">in</span> <span class="n">all_commands</span>
                    <span class="p">}</span>
                    <span class="n">subcmds</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="o">*</span><span class="n">new_subcmds</span><span class="p">,</span> <span class="n">new_pref</span><span class="p">])</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;subcommands:</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">subcmds</span>

    <span class="n">recurse</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">root_prefix</span><span class="p">)</span>
    <span class="n">all_commands</span><span class="p">[</span><span class="n">root_prefix</span><span class="p">][</span><span class="s2">&quot;commands&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]:</span> <span class="n">options</span>
        <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_commands</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;paths&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="n">root_prefix</span>
    <span class="p">}</span>
    <span class="n">subcommands</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="n">options</span>
        <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="n">all_commands</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;commands&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">subcommands</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">root_prefix</span><span class="p">,</span> <span class="n">all_commands</span><span class="p">[</span><span class="n">root_prefix</span><span class="p">])</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;subcommands:</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">root_prefix</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_commands</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">command_case</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">]</span>
        <span class="n">case_fmt_on_no_sub</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;{name}) _arguments -C ${prefix}_{name_wordify}_options ;;&quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">case_fmt_on_sub</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="si">{name}</span><span class="s2">) </span><span class="si">{prefix}</span><span class="s2">_</span><span class="si">{name_wordify}</span><span class="s2"> ;;&quot;&quot;&quot;</span>

        <span class="n">cases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">case_fmt_on_sub</span> <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;commands&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">case_fmt_on_no_sub</span>
            <span class="n">cases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">],</span>
                    <span class="n">name_wordify</span><span class="o">=</span><span class="n">wordify</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">]),</span>
                    <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">expandtabs</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cases</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="si">{prefix}</span><span class="s2">() {{</span>
<span class="s2">  local context state line curcontext=&quot;$curcontext&quot;</span>

<span class="s2">  _arguments -C $</span><span class="si">{prefix}</span><span class="s2">_options </span><span class="se">\\</span><span class="s2"></span>
<span class="s2">    &#39;: :</span><span class="si">{prefix}</span><span class="s2">_commands&#39; </span><span class="se">\\</span><span class="s2"></span>
<span class="s2">    &#39;*::: :-&gt;</span><span class="si">{name}</span><span class="s2">&#39;</span>

<span class="s2">  case $state in</span>
<span class="s2">    </span><span class="si">{name}</span><span class="s2">)</span>
<span class="s2">      words=($line[1] &quot;${{words[@]}}&quot;)</span>
<span class="s2">      (( CURRENT += 1 ))</span>
<span class="s2">      curcontext=&quot;${{curcontext%:*:*}}:</span><span class="si">{prefix}</span><span class="s2">-$line[1]:&quot;</span>
<span class="s2">      case $line[1] in</span>
<span class="s2">        </span><span class="si">{cases}</span><span class="s2"></span>
<span class="s2">      esac</span>
<span class="s2">  esac</span>
<span class="s2">}}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">cases</span><span class="o">=</span><span class="n">cases</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_option</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="si">{prefix}</span><span class="s2">_options=(</span>
<span class="s2">  </span><span class="si">{arguments}</span><span class="s2"></span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_list</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">prog</span><span class="p">,</span> <span class="o">*</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;paths&quot;</span><span class="p">]])</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">escape_zsh</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">escape_zsh</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;help&quot;</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">opt</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{prefix}</span><span class="s2">_commands() {{</span>
<span class="s2">  local _commands=(</span>
<span class="s2">    </span><span class="si">{commands}</span><span class="s2"></span>
<span class="s2">  )</span>
<span class="s2">  _describe &#39;</span><span class="si">{name}</span><span class="s2"> commands&#39; _commands</span>
<span class="s2">}}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">commands</span><span class="o">=</span><span class="n">commands</span>
        <span class="p">)</span>

    <span class="n">preamble</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd"># Custom Preamble</span>
<span class="sd">{}</span>

<span class="sd"># End Custom Preamble</span>
<span class="sd">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">preamble</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">preamble</span>
        <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="p">)</span>
    <span class="c1"># References:</span>
    <span class="c1">#   - https://github.com/zsh-users/zsh-completions</span>
    <span class="c1">#   - http://zsh.sourceforge.net/Doc/Release/Completion-System.html</span>
    <span class="c1">#   - https://mads-hartmann.com/2017/08/06/</span>
    <span class="c1">#     writing-zsh-completion-scripts.html</span>
    <span class="c1">#   - http://www.linux-mag.com/id/1106/</span>
    <span class="k">return</span> <span class="n">Template</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">#compdef ${prog}</span>

<span class="sd"># AUTOMATCALLY GENERATED by `shtab`</span>

<span class="sd">${command_commands}</span>

<span class="sd">${command_options}</span>

<span class="sd">${command_cases}</span>
<span class="sd">${preamble}</span>

<span class="sd">typeset -A opt_args</span>
<span class="sd">${root_prefix} &quot;$@\&quot;&quot;&quot;</span><span class="s2">&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
        <span class="n">prog</span><span class="o">=</span><span class="n">prog</span><span class="p">,</span>
        <span class="n">root_prefix</span><span class="o">=</span><span class="n">root_prefix</span><span class="p">,</span>
        <span class="n">command_cases</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">starmap</span><span class="p">(</span><span class="n">command_case</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">subcommands</span><span class="o">.</span><span class="n">items</span><span class="p">()))),</span>
        <span class="n">command_commands</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">starmap</span><span class="p">(</span><span class="n">command_list</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">subcommands</span><span class="o">.</span><span class="n">items</span><span class="p">()))),</span>
        <span class="n">command_options</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">starmap</span><span class="p">(</span><span class="n">command_option</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_commands</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="p">),</span>
        <span class="n">preamble</span><span class="o">=</span><span class="n">preamble</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@mark_completer</span><span class="p">(</span><span class="s2">&quot;tcsh&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">complete_tcsh</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">root_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preamble</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">choice_functions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return tcsh syntax autocompletion script.</span>

<span class="sd">    See `complete` for arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optionals_single</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">optionals_double</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">specials</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index_choices</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">choice_type2fn</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;tcsh&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">CHOICE_FUNCTIONS</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">choice_functions</span><span class="p">:</span>
        <span class="n">choice_type2fn</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">choice_functions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_specials</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg_type</span><span class="p">,</span> <span class="n">arg_sel</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
            <span class="n">choice_strs</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">choices</span><span class="p">))</span>
            <span class="k">yield</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/(</span><span class="si">{}</span><span class="s2">)/&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">arg_type</span><span class="p">,</span>
                <span class="n">arg_sel</span><span class="p">,</span>
                <span class="n">choice_strs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;complete&quot;</span><span class="p">):</span>
            <span class="n">complete_fn</span> <span class="o">=</span> <span class="n">complete2pattern</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">complete</span><span class="p">,</span> <span class="s2">&quot;tcsh&quot;</span><span class="p">,</span> <span class="n">choice_type2fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">complete_fn</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">arg_type</span><span class="p">,</span>
                    <span class="n">arg_sel</span><span class="p">,</span>
                    <span class="n">complete_fn</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">recurse_parser</span><span class="p">(</span><span class="n">cparser</span><span class="p">,</span> <span class="n">positional_idx</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">log_prefix</span> <span class="o">=</span> <span class="s2">&quot;| &quot;</span> <span class="o">*</span> <span class="n">positional_idx</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">Parser @ </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">log_prefix</span><span class="p">,</span> <span class="n">positional_idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">requirements</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">- Requires: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">log_prefix</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">requirements</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">requirements</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">optional</span> <span class="ow">in</span> <span class="n">cparser</span><span class="o">.</span><span class="n">_get_optional_actions</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">| Optional: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">log_prefix</span><span class="p">,</span> <span class="n">optional</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">optional</span><span class="o">.</span><span class="n">help</span> <span class="o">!=</span> <span class="n">SUPPRESS</span><span class="p">:</span>
                <span class="c1"># Mingle all optional arguments for all subparsers</span>
                <span class="k">for</span> <span class="n">optional_str</span> <span class="ow">in</span> <span class="n">optional</span><span class="o">.</span><span class="n">option_strings</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">| | </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">log_prefix</span><span class="p">,</span> <span class="n">optional_str</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">optional_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">):</span>
                        <span class="n">optionals_double</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">optional_str</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                    <span class="k">elif</span> <span class="n">optional_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                        <span class="n">optionals_single</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">optional_str</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">specials</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_specials</span><span class="p">(</span><span class="n">optional</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="n">optional_str</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">positional</span> <span class="ow">in</span> <span class="n">cparser</span><span class="o">.</span><span class="n">_get_positional_actions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">positional</span><span class="o">.</span><span class="n">help</span> <span class="o">!=</span> <span class="n">SUPPRESS</span><span class="p">:</span>
                <span class="n">positional_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">| Positional #</span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">log_prefix</span><span class="p">,</span>
                    <span class="n">positional_idx</span><span class="p">,</span>
                    <span class="n">positional</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">index_choices</span><span class="p">[</span><span class="n">positional_idx</span><span class="p">][</span><span class="nb">tuple</span><span class="p">(</span><span class="n">requirements</span><span class="p">)]</span> <span class="o">=</span> <span class="n">positional</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">requirements</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">positional</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">subcmd</span><span class="p">,</span> <span class="n">subparser</span> <span class="ow">in</span> <span class="n">positional</span><span class="o">.</span><span class="n">choices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">| | SubParser: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">log_prefix</span><span class="p">,</span> <span class="n">subcmd</span><span class="p">)</span>
                        <span class="n">recurse_parser</span><span class="p">(</span>
                            <span class="n">subparser</span><span class="p">,</span> <span class="n">positional_idx</span><span class="p">,</span> <span class="n">requirements</span> <span class="o">+</span> <span class="p">[</span><span class="n">subcmd</span><span class="p">]</span>
                        <span class="p">)</span>

    <span class="n">recurse_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ndict</span> <span class="ow">in</span> <span class="n">index_choices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Single choice, no requirements</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ndict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">specials</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_specials</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Multiple requirements</span>
            <span class="n">nlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">nn</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">ndict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">checks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;[ &quot;$cmd[</span><span class="si">{}</span><span class="s1">]&quot; == &quot;</span><span class="si">{}</span><span class="s1">&quot; ]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iidx</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">iidx</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
                    <span class="n">nlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s1">&#39;( </span><span class="si">{}</span><span class="s1">echo &quot;</span><span class="si">{}</span><span class="s1">&quot; || false )&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="s2">&quot; &amp;&amp; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checks</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]),</span>  <span class="c1"># Append the separator</span>
                            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">choices</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="c1"># Ugly hack</span>
            <span class="n">specials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;&#39;p@</span><span class="si">{}</span><span class="s2">@`set cmd=($COMMAND_LINE); </span><span class="si">{}</span><span class="s2">`@&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="s2">&quot; || &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nlist</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">Template</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd"># AUTOMATICALLY GENERATED by `shtab`</span>

<span class="sd">${preamble}</span>

<span class="sd">complete ${prog} \\</span>
<span class="sd">        &#39;c/--/(${optionals_double_str})/&#39; \\</span>
<span class="sd">        &#39;c/-/(${optionals_single_str} -)/&#39; \\</span>
<span class="sd">        ${optionals_special_str} \\</span>
<span class="sd">        &#39;p/*/()/&#39;&quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
        <span class="n">preamble</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># Custom Preamble</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">preamble</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># End Custom Preamble</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">preamble</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">),</span>
        <span class="n">root_prefix</span><span class="o">=</span><span class="n">root_prefix</span><span class="p">,</span>
        <span class="n">prog</span><span class="o">=</span><span class="n">parser</span><span class="o">.</span><span class="n">prog</span><span class="p">,</span>
        <span class="n">optionals_double_str</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">optionals_double</span><span class="p">),</span>
        <span class="n">optionals_single_str</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">optionals_single</span><span class="p">),</span>
        <span class="n">optionals_special_str</span><span class="o">=</span><span class="s2">&quot; </span><span class="se">\\\n</span><span class="s2">        &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">specials</span><span class="p">),</span>
    <span class="p">)</span>


<div class="viewcode-block" id="complete"><a class="viewcode-back" href="../../../api/tyro/_shtab/#tyro._shtab.complete">[docs]</a><span class="k">def</span> <span class="nf">complete</span><span class="p">(</span>
    <span class="n">parser</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">,</span>
    <span class="n">shell</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bash&quot;</span><span class="p">,</span>
    <span class="n">root_prefix</span><span class="p">:</span> <span class="n">Opt</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">preamble</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">choice_functions</span><span class="p">:</span> <span class="n">Opt</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    parser  : argparse.ArgumentParser</span>
<span class="sd">    shell  : str (bash/zsh)</span>
<span class="sd">    root_prefix  : str or `None`</span>
<span class="sd">      prefix for shell functions to avoid clashes (default: &quot;_{parser.prog}&quot;)</span>
<span class="sd">    preamble  : dict or str</span>
<span class="sd">      mapping shell to text to prepend to generated script</span>
<span class="sd">      (e.g. `{&quot;bash&quot;: &quot;_myprog_custom_function(){ echo hello }&quot;}`)</span>
<span class="sd">    choice_functions  : deprecated</span>

<span class="sd">    N.B. `parser.add_argument().complete = ...` can be used to define custom</span>
<span class="sd">    completions (e.g. filenames). See &lt;../examples/pathcomplete.py&gt;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">preamble</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">preamble</span> <span class="o">=</span> <span class="n">preamble</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">completer</span> <span class="o">=</span> <span class="n">get_completer</span><span class="p">(</span><span class="n">shell</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">completer</span><span class="p">(</span>
        <span class="n">parser</span><span class="p">,</span>
        <span class="n">root_prefix</span><span class="o">=</span><span class="n">root_prefix</span><span class="p">,</span>
        <span class="n">preamble</span><span class="o">=</span><span class="n">preamble</span><span class="p">,</span>
        <span class="n">choice_functions</span><span class="o">=</span><span class="n">choice_functions</span><span class="p">,</span>
    <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">completion_action</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preamble</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">PrintCompletionAction</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">complete</span><span class="p">(</span><span class="n">parent</span> <span class="ow">or</span> <span class="n">parser</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">preamble</span><span class="o">=</span><span class="n">preamble</span><span class="p">))</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">PrintCompletionAction</span>


<div class="viewcode-block" id="add_argument_to"><a class="viewcode-back" href="../../../api/tyro/_shtab/#tyro._shtab.add_argument_to">[docs]</a><span class="k">def</span> <span class="nf">add_argument_to</span><span class="p">(</span>
    <span class="n">parser</span><span class="p">,</span>
    <span class="n">option_string</span><span class="o">=</span><span class="s2">&quot;--print-completion&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;print shell completion script&quot;</span><span class="p">,</span>
    <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preamble</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    parser  : argparse.ArgumentParser</span>
<span class="sd">    option_string  : str or list[str]</span>
<span class="sd">      iff positional (no `-` prefix) then `parser` is assumed to actually be</span>
<span class="sd">      a subparser (subcommand mode)</span>
<span class="sd">    help  : str</span>
<span class="sd">    parent  : argparse.ArgumentParser</span>
<span class="sd">      required in subcommand mode</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">option_string</span><span class="p">,</span> <span class="nb">str</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">basestring</span>  <span class="c1"># NOQA</span>
    <span class="p">):</span>
        <span class="n">option_string</span> <span class="o">=</span> <span class="p">[</span><span class="n">option_string</span><span class="p">]</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">SUPPORTED_SHELLS</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="n">help</span><span class="p">,</span>
        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">completion_action</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">preamble</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">option_string</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>  <span class="c1"># subparser mode</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">SUPPORTED_SHELLS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;subcommand mode: parent required&quot;</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="o">*</span><span class="n">option_string</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span></div>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/brentyi/tyro" aria-label="GitHub">
            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
            </svg>
        </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/scripts/furo.js"></script>
    </body>
</html>